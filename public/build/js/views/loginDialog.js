define(["jquery","underscore","text!templates/login.html","views/flashMessage","i18n!nls/trailsy"],function(a,b,c,d,e){var f={loginHtml:null,mask:a("#mask"),errorDiv:null,form:null,show:function(){if(null===this.loginHtml){var d=b.template(c);this.loginHtml=a(d(e)),a("nav").append(this.loginHtml),this.errorDiv=a("#login-box .error"),this.form=a("#login-box form")}this.loginHtml.css({"margin-top":(this.loginHtml.height()+24)/-2,"margin-left":(this.loginHtml.width()+24)/-2}),this.mask.fadeIn(300),this.loginHtml.fadeIn(300),a("#login-box a, #mask").on("click",b.bind(this.hide,this)),this.form.on("submit",b.bind(this.submitForm,this)),a("#login-box #email").focus()},hide:function(){a("#mask , #login-box").fadeOut(300,b.bind(function(){this.clearErrors(),a("#login-box form input").val(""),a("#login-box a, #mask").unbind(),this.form.unbind()},this)),AppRouter.navigate("home",!0)},clearErrors:function(){this.errorDiv.hide(),this.errorDiv.empty()},submitForm:function(){this.form.length&&a.ajax({url:"/sessions",data:this.form.serialize(),type:"POST",beforeSend:b.bind(function(b){var c=a('meta[name="csrf-token"]').attr("content");c&&b.setRequestHeader("X-CSRF-Token",c),this.clearErrors()},this),success:b.bind(this.loginSuccess,this),error:b.bind(this.loginError,this)})},loginSuccess:function(){d.showMessage("info",e.login_success),a("#loginLink").addClass("hidden"),a("#logoutLink").removeClass("hidden"),a("#signupLink").addClass("hidden"),AppRouter.setLoginState(!0),this.hide()},loginError:function(){this.errorDiv.text(e.login_error),this.errorDiv.show()},logout:function(){a.ajax({url:"/log_out",type:"GET",contentType:"application/json; charset=utf-8",beforeSend:function(b){var c=a('meta[name="csrf-token"]').attr("content");c&&b.setRequestHeader("X-CSRF-Token",c)},success:b.bind(function(){a("#logoutLink").addClass("hidden"),a("#loginLink").removeClass("hidden"),a("#signupLink").removeClass("hidden"),AppRouter.setLoginState(!1),d.showMessage("info",e.logout_success)},this),error:b.bind(function(){d.showMessage("error",e.logout_error)},this)})}};return f})